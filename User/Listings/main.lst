C51 COMPILER V9.54   MAIN                                                                  07/14/2021 15:41:59 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN ..\Obj\main.obj
COMPILER INVOKED BY: D:\Program Files\Keil\Keil_v5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE INCDIR(..\Hardware;..
                    -\Peripheral;..\Sys;..\User) DEBUG OBJECTEXTEND PRINT(.\Listings\main.lst) OBJECT(..\Obj\main.obj)

line level    source

   1          #include        "config.h"
   2          #include        "GPIO.h"
   3          #include        "USART.h"
   4          #include        "delay.h"
   5          #include        "timer.h"
   6          #include        "SPI.h"
   7          #include        "MCP3302.h"
   8          
   9          /*************  ¹¦ÄÜËµÃ÷        **************
  10          
  11          
  12          
  13          ******************************************/
  14          
  15          /*************  ±¾µØ³£Á¿ÉùÃ÷    **************/
  16          
  17          
  18          /*************  ±¾µØ±äÁ¿ÉùÃ÷    **************/
  19          
  20          
  21          /*************  ±¾µØº¯ÊýÉùÃ÷    **************/
  22          
  23          
  24          
  25          /*************  Íâ²¿º¯ÊýºÍ±äÁ¿ÉùÃ÷ *****************/
  26          extern u8       SPI_BUF_type SPI_RxBuffer[SPI_BUF_LENTH];
  27          extern u8       SPI_BUF_type SPI_TxBuffer[SPI_BUF_LENTH];
  28          
  29          
  30          /******************** IOÅäÖÃº¯Êý **************************/
  31          void    GPIO_config(void)
  32          {
  33   1              GPIO_InitTypeDef        GPIO_InitStructure;             //½á¹¹¶¨Òå
  34   1              GPIO_InitStructure.Pin  = GPIO_Pin_All;         //Ö¸¶¨Òª³õÊ¼»¯µÄIO, GPIO_Pin_0 ~ GPIO_Pin_7, »ò²Ù×÷
  35   1              GPIO_InitStructure.Mode = GPIO_OUT_PP;          //Ö¸¶¨IOµÄÊäÈë»òÊä³ö·½Ê½,GPIO_PullUp,GPIO_HighZ,GPIO_OUT_OD,GPIO_
             -OUT_PP
  36   1              GPIO_Inilize(GPIO_P1,&GPIO_InitStructure);      //³õÊ¼»¯
  37   1              GPIO_Inilize(GPIO_P2,&GPIO_InitStructure);
  38   1              GPIO_Inilize(GPIO_P3,&GPIO_InitStructure);
  39   1      
  40   1      }
  41          
  42          
  43          /******************** ´®¿ÚÅäÖÃº¯Êý **************************/
  44          void    UART_config(void)
  45          {
  46   1              COMx_InitDefine         COMx_InitStructure;                                     //½á¹¹¶¨Òå
  47   1              COMx_InitStructure.UART_Mode      = UART_8bit_BRTx;             //Ä£Ê½,       UART_ShiftRight,UART_8bit_BRTx,UART_9b
             -it,UART_9bit_BRTx
  48   1              COMx_InitStructure.UART_BRT_Use   = BRT_Timer1;                 //Ê¹ÓÃ²¨ÌØÂÊ,   BRT_Timer1, BRT_Timer2 (×¢Òâ: ´®¿Ú2¹Ì¶¨
             -Ê¹ÓÃBRT_Timer2)
  49   1              COMx_InitStructure.UART_BaudRate  = 9600ul;                     //²¨ÌØÂÊ, Ò»°ã 110 ~ 115200
  50   1              COMx_InitStructure.UART_RxEnable  = ENABLE;                             //½ÓÊÕÔÊÐí,   ENABLE»òDISABLE
  51   1              COMx_InitStructure.UART_Interrupt = ENABLE;                             //ÖÐ¶ÏÔÊÐí,   ENABLE»òDISABLE
C51 COMPILER V9.54   MAIN                                                                  07/14/2021 15:41:59 PAGE 2   

  52   1              COMx_InitStructure.UART_P_SW      = UART1_SW_P30_P31;   //ÇÐ»»¶Ë¿Ú,   UART1_SW_P30_P31,UART1_SW_P36_P37,UAR
             -T1_SW_P16_P17(±ØÐëÊ¹ÓÃÄÚ²¿Ê±ÖÓ)
  53   1              USART_Configuration(USART1, &COMx_InitStructure);               //³õÊ¼»¯´®¿Ú3 USART1,USART2
  54   1      
  55   1              // PrintString(USART1,"STC15F2K60S2 SPI Test Prgramme!\r\n");   //USART1·¢ËÍÒ»¸ö×Ö·û´®
  56   1      
  57   1      }
  58          
  59          /************************ ¶¨Ê±Æ÷ÅäÖÃ ****************************/
  60          void    Timer_config(void)
  61          {
  62   1              TIM_InitTypeDef         TIM_InitStructure;                                      //½á¹¹¶¨Òå
  63   1              /*
  64   1              TIM_InitStructure.TIM_Mode      = TIM_16BitAutoReload;  //Ö¸¶¨¹¤×÷Ä£Ê½,   TIM_16BitAutoReload,TIM_16Bit,TI
             -M_8BitAutoReload,TIM_16BitAutoReloadNoMask
  65   1              TIM_InitStructure.TIM_Polity    = PolityLow;                    //Ö¸¶¨ÖÐ¶ÏÓÅÏÈ¼¶, PolityHigh,PolityLow
  66   1              TIM_InitStructure.TIM_Interrupt = ENABLE;                               //ÖÐ¶ÏÊÇ·ñÔÊÐí,   ENABLE»òDISABLE
  67   1              TIM_InitStructure.TIM_ClkSource = TIM_CLOCK_1T;                 //Ö¸¶¨Ê±ÖÓÔ´,     TIM_CLOCK_1T,TIM_CLOCK_12T,TIM_CLOCK_
             -Ext
  68   1              TIM_InitStructure.TIM_ClkOut    = ENABLE;                               //ÊÇ·ñÊä³ö¸ßËÙÂö³å, ENABLE»òDISABLE
  69   1              TIM_InitStructure.TIM_Value     = 65536UL - (MAIN_Fosc / 20000);                //³õÖµ,
  70   1              TIM_InitStructure.TIM_Run       = ENABLE;                               //ÊÇ·ñ³õÊ¼»¯ºóÆô¶¯¶¨Ê±Æ÷, ENABLE»òDISABLE
  71   1              Timer_Inilize(Timer0,&TIM_InitStructure);                               //³õÊ¼»¯Timer0    Timer0,Timer1,Timer2,Timer3,Timer4
  72   1              
  73   1              TIM_InitStructure.TIM_Mode      = TIM_16BitAutoReload;  //Ö¸¶¨¹¤×÷Ä£Ê½,   TIM_16BitAutoReload,TIM_16Bit,TI
             -M_8BitAutoReload
  74   1              TIM_InitStructure.TIM_Polity    = PolityLow;                    //Ö¸¶¨ÖÐ¶ÏÓÅÏÈ¼¶, PolityHigh,PolityLow
  75   1              TIM_InitStructure.TIM_Interrupt = ENABLE;                               //ÖÐ¶ÏÊÇ·ñÔÊÐí,   ENABLE»òDISABLE
  76   1              TIM_InitStructure.TIM_ClkSource = TIM_CLOCK_1T;                 //Ö¸¶¨Ê±ÖÓÔ´, TIM_CLOCK_1T,TIM_CLOCK_12T,TIM_CLOCK_Ext
  77   1              TIM_InitStructure.TIM_ClkOut    = DISABLE;                              //ÊÇ·ñÊä³ö¸ßËÙÂö³å, ENABLE»òDISABLE
  78   1              TIM_InitStructure.TIM_Value     = 65536UL - (MAIN_Fosc / 1000);         //³õÖµ,
  79   1              TIM_InitStructure.TIM_Run       = ENABLE;                               //ÊÇ·ñ³õÊ¼»¯ºóÆô¶¯¶¨Ê±Æ÷, ENABLE»òDISABLE
  80   1              Timer_Inilize(Timer1,&TIM_InitStructure);                               //³õÊ¼»¯Timer1    Timer0,Timer1,Timer2,Timer3,Timer4
  81   1              */
  82   1              TIM_InitStructure.TIM_Interrupt = DISABLE;                              //ÖÐ¶ÏÊÇ·ñÔÊÐí,   ENABLE»òDISABLE. (×¢Òâ: Timer2¹Ì¶¨Îª16Î»×
             -Ô¶¯ÖØ×°, ÖÐ¶Ï¹Ì¶¨ÎªµÍÓÅÏÈ¼¶)
  83   1              TIM_InitStructure.TIM_ClkSource = TIM_CLOCK_12T;                //Ö¸¶¨Ê±ÖÓÔ´,     TIM_CLOCK_1T,TIM_CLOCK_12T,TIM_CLOCK_
             -Ext
  84   1              TIM_InitStructure.TIM_ClkOut    = DISABLE;                              //ÊÇ·ñÊä³ö¸ßËÙÂö³å, ENABLE»òDISABLE
  85   1              TIM_InitStructure.TIM_Value     = 65536UL - (MAIN_Fosc / (1000*12));            //³õÖµ
  86   1              TIM_InitStructure.TIM_Run       = ENABLE;                               //ÊÇ·ñ³õÊ¼»¯ºóÆô¶¯¶¨Ê±Æ÷, ENABLE»òDISABLE
  87   1              Timer_Inilize(Timer2,&TIM_InitStructure);                               //³õÊ¼»¯Timer2    Timer0,Timer1,Timer2,Timer3,Timer4
  88   1              
  89   1              TIM_InitStructure.TIM_Interrupt = ENABLE;                               //ÖÐ¶ÏÊÇ·ñÔÊÐí,   ENABLE»òDISABLE. (×¢Òâ: Timer2¹Ì¶¨Îª16Î»×Ô
             -¶¯ÖØ×°, ÖÐ¶Ï¹Ì¶¨ÎªµÍÓÅÏÈ¼¶)
  90   1              TIM_InitStructure.TIM_ClkSource = TIM_CLOCK_12T;                //Ö¸¶¨Ê±ÖÓÔ´,     TIM_CLOCK_1T,TIM_CLOCK_12T,TIM_CLOCK_
             -Ext
  91   1              TIM_InitStructure.TIM_ClkOut    = ENABLE;                               //ÊÇ·ñÊä³ö¸ßËÙÂö³å, ENABLE»òDISABLE
  92   1              TIM_InitStructure.TIM_Value     = 65536UL - (MAIN_Fosc / (100*12));             //³õÖµ
  93   1              TIM_InitStructure.TIM_Run       = ENABLE;                               //ÊÇ·ñ³õÊ¼»¯ºóÆô¶¯¶¨Ê±Æ÷, ENABLE»òDISABLE
  94   1              Timer_Inilize(Timer3,&TIM_InitStructure);                               //³õÊ¼»¯Timer3    Timer0,Timer1,Timer2,Timer3,Timer4
  95   1              
  96   1              TIM_InitStructure.TIM_Interrupt = ENABLE;                               //ÖÐ¶ÏÊÇ·ñÔÊÐí,   ENABLE»òDISABLE. (×¢Òâ: Timer2¹Ì¶¨Îª16Î»×Ô
             -¶¯ÖØ×°, ÖÐ¶Ï¹Ì¶¨ÎªµÍÓÅÏÈ¼¶)
  97   1              TIM_InitStructure.TIM_ClkSource = TIM_CLOCK_12T;                //Ö¸¶¨Ê±ÖÓÔ´,     TIM_CLOCK_1T,TIM_CLOCK_12T,TIM_CLOCK_
             -Ext
  98   1              TIM_InitStructure.TIM_ClkOut    = DISABLE;                              //ÊÇ·ñÊä³ö¸ßËÙÂö³å, ENABLE»òDISABLE
  99   1              TIM_InitStructure.TIM_Value     = 65536UL - (MAIN_Fosc / (100*12));             //³õÖµ
 100   1              TIM_InitStructure.TIM_Run       = ENABLE;                               //ÊÇ·ñ³õÊ¼»¯ºóÆô¶¯¶¨Ê±Æ÷, ENABLE»òDISABLE
 101   1              Timer_Inilize(Timer4,&TIM_InitStructure);                               //³õÊ¼»¯Timer4    Timer0,Timer1,Timer2,Timer3,Timer4
 102   1              
 103   1      }
C51 COMPILER V9.54   MAIN                                                                  07/14/2021 15:41:59 PAGE 3   

 104          
 105          void    SPI_config(void)
 106          {
 107   1              SPI_InitTypeDef         SPI_InitStructure;
 108   1              SPI_InitStructure.SPI_Module    = ENABLE;              //SPIÆô¶¯    ENABLE, DISABLE
 109   1              SPI_InitStructure.SPI_SSIG      = DISABLE;                        //Æ¬Ñ¡Î»     ENABLE, DISABLE
 110   1              SPI_InitStructure.SPI_FirstBit  = SPI_MSB;                        //ÒÆÎ»·½Ïò   SPI_MSB, SPI_LSB
 111   1              SPI_InitStructure.SPI_Mode      = SPI_Mode_Slave;         //Ö÷´ÓÑ¡Ôñ   SPI_Mode_Master, SPI_Mode_Slave
 112   1              SPI_InitStructure.SPI_CPOL      = SPI_CPOL_High;      //Ê±ÖÓÏàÎ»   SPI_CPOL_High,   SPI_CPOL_Low
 113   1              SPI_InitStructure.SPI_CPHA      = SPI_CPHA_2Edge;         //Êý¾Ý±ßÑØ   SPI_CPHA_1Edge,  SPI_CPHA_2Edge
 114   1              SPI_InitStructure.SPI_Interrupt = ENABLE;                         //ÖÐ¶ÏÔÊÐí   ENABLE,DISABLE
 115   1              SPI_InitStructure.SPI_Speed     = SPI_Speed_64;           //SPIËÙ¶È    SPI_Speed_4, SPI_Speed_16, SPI_Speed_64, 
             -SPI_Speed_128
 116   1              SPI_InitStructure.SPI_IoUse     = SPI_P12_P13_P14_P15; //IO¿ÚÇÐ»»   SPI_P12_P13_P14_P15, SPI_P24_P23_P22_
             -P21, SPI_P54_P40_P41_P43
 117   1              SPI_Init(&SPI_InitStructure);
 118   1              
 119   1              SPI_TxRxMode = SPI_Mode_Slave;
 120   1      }
 121          
 122          /******************** Ö÷º¯Êý **************************/
 123          void main(void)
 124          {
 125   1      
 126   1              u8 i;
 127   1              Timer_config();
 128   1              GPIO_config();
 129   1              UART_config();
 130   1              SPI_config();
 131   1      
 132   1              EA = 1;
 133   1      
 134   1              delay_ms(200);
 135   1      
 136   1              while(1)
 137   1              {
 138   2      
 139   2                      // SPI_TxRead = 0;
 140   2                      // SPI_TxWrite = 0;
 141   2                      // SPI_RxCnt = 0;
 142   2                      
 143   2                      // SPI_WriteToTxBuf((u8)macpdata>>16);
 144   2                      // SPI_WriteToTxBuf((u8)macpdata>>8);
 145   2                      // SPI_WriteToTxBuf((u8)(macpdata));
 146   2                      // SPI_WriteToTxBuf((u8)0xa0);
 147   2                      // SPI_WriteToTxBuf((u8)0x00);
 148   2                      // SPI_WriteToTxBuf((u8)0x00);
 149   2                      // SPI_TrigTx();
 150   2                      delay_ms(500);
 151   2                      PrintString(USART1,"STC15F2K60S2 SPI Test Prgramme!");  //USART1·¢ËÍÒ»¸ö×Ö·û´®
 152   2                      // SPI_WriteToTxBuf(0x12);
 153   2                      // SPI_WriteToTxBuf((u8)0x00);
 154   2                      // SPI_WriteToTxBuf((u8)0x00);
 155   2                      // SPI_TrigTx();
 156   2                      // delay_ms(250);
 157   2                      ////////////////////////////
 158   2      
 159   2                      ////////////////////////////////
 160   2                      if(SPI_RxTimerOut > 0)
 161   2                      {
 162   3                              if(--SPI_RxTimerOut == 0)
 163   3                              {
C51 COMPILER V9.54   MAIN                                                                  07/14/2021 15:41:59 PAGE 4   

 164   4                                                              PrintString(USART1,"STC15F2K60S2 SPI Test Prgramme!\r\n");      //USART1·¢ËÍÒ»¸ö×Ö·û´®
 165   4      
 166   4                                      if(SPI_RxCnt > 1)
 167   4                                      {
 168   5                                              i = 0;
 169   5                                              if(SPI_TxRxMode == SPI_Mode_Master)     i++;
 170   5                                              else                                    SPI_RxCnt--;
 171   5                                              for(; i<SPI_RxCnt; i++) PrintString(USART1,&SPI_RxBuffer[i]);
 172   5                                      }
 173   4                                      SPI_RxCnt = 0;  //B_SPI_RxOk = 0;
 174   4                              }
 175   3                      }
 176   2                      ////////////////////////////////////
 177   2      
 178   2              }
 179   1      }
 180          
 181          
 182          
 183          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    298    ----
   CONSTANT SIZE    =     66    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----      29
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
